<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Weperch Technologies Ltd">
    <meta name="description" content="ASFI, African Science Frontiers Initiative, African Scientists, African Scholars, Scholars, Education">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            600: '#7e22ce',
                            700: '#6b21a8',
                        },
                        secondary: {
                            600: '#2563eb',
                        },
                        pink: {
                            500: '#ec4899',
                        },
                        red: {
                            500: '#ef4444',
                        },
                        yellow: {
                            400: '#facc15',
                        }
                    },
                    fontFamily: {
                        inter: [ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"],
                        roboto: [ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"],
                        poppins: [ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"],
                    },
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="/files/images/ASFIScholar_Logo.png" type="image/x-icon">

    <title><%=PosterTitle%> | ASFI Scholar</title>
    
    <style>
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s, visibility 0.5s;
        }
        
        .circular-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e5e7eb;
        }
        
        .reaction-btn {
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 20px;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .reaction-btn:hover {
            transform: translateY(-2px);
        }
        
        .reaction-count {
            margin-left: 6px;
            font-weight: 500;
        }
        
        .star-rating .star {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .star-rating .star:hover {
            transform: scale(1.2);
        }
        
        .chatBox {
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .back-top {
            transition: all 0.3s ease;
        }
        
        .back-top:hover {
            transform: translateY(-3px);
        }
        
        #pdf-container-1 {
            width: 100%;
            height: 100%;
            min-height: 500px;
            overflow: auto;
            cursor: zoom-in;
            transition: all 0.3s ease;
        }
        
        #pdf-container-1.zoomed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9998;
            cursor: zoom-out;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #pdf-container-1.zoomed .pdf-page {
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .pdf-page {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        #pdf-container-1:not(.zoomed) .pdf-page:hover {
            transform: scale(1.02);
        }
        
        .pdf-page:last-child {
            margin-bottom: 0;
        }
        
        #pdf-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .close-zoom {
            /* position: absolute; */
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 9999;
            display: none;
        }
        
        #pdf-container-1.zoomed ~ .close-zoom {
            display: block;
        }
    </style>
</head>

<body class="font-poppins bg-gray-50">

<div class="loader-overlay" id="loader-overlay">
    <div class="flex flex-col items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"></div>
        <span class="text-primary-600">Loading</span>
    </div>
</div>

<input type="hidden" id="posterID" value="<%=PosterId%>" readonly>

<!-- Header START -->
<%- include('./partials/header.ejs')%>
<!-- Header END -->

<!-- Main Content START -->
<main class="py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">
        <!-- Poster Preview Section -->
        <section class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="md:flex">
                <!-- PDF Preview -->
                <div class="md:w-2/3 p-6 relative" style="min-height: 80vh;">
                    <input type="hidden" id="posterDeckFile" value="<%=PosterFile%>">
                    <input type="hidden" id="presenterImageFile" value="<%=PresenterImage%>">
                    
                    <div id="pdf-container-1" class="w-full h-full">
                        <div id="pdf-loading" class="text-center">
                            <i class="fas fa-file-pdf text-6xl text-red-500 mb-2"></i>
                            <p class="text-gray-600">Loading PDF preview...</p>
                        </div>
                    </div>
                    <div class="close-zoom" id="closeZoom">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                
                <!-- Poster Info -->
                <div class="md:w-1/3 p-6 border-l border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-regular text-gray-900"><%=PosterTitle%></h2>
                        <span class="flex items-center text-gray-500">
                            <i class="fas fa-eye mr-1"></i>
                            <span id="view_count_container"><%=ViewsCount%></span>
                        </span>
                    </div>
                    
                    <!-- Presenter Info -->
                    <div class="mb-6">
                        <h5 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Presented By</h5>
                        <div class="flex items-center">
                            <img alt="Presenter" class="circular-image" id="presenterImage" src="<%= PresenterImage %>">
                            <div class="ml-4">
                                <p class="font-medium text-gray-900"><%=Presenter%></p>
                                <p class="text-sm text-gray-500"><%= affiliation %> <%= country %></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mb-6">
                        <% if(isOwner === true) { %>
                            <button id="chatPresenter" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md transition-all">
                                <i class="fas fa-comments mr-2"></i> See Messages
                            </button>
                        <% } else { %>
                            <button id="chatPresenter" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md transition-all">
                                <i class="fas fa-comments mr-2"></i> Chat With Presenter
                            </button>
                        <% } %>
                    </div>
                    
                    <!-- Reactions -->
                    <div class="mb-6">
                        <div class="flex flex-wrap mb-4">
                            <% if(isOwner === true) { %>
                                <div class="reaction-btn bg-gray-100 text-gray-800" title="You cannot like your own poster">
                                    <i class="fas fa-heart text-red-500"></i>
                                    <span class="reaction-count" id="like_count_container"><%=likes_count%></span>
                                </div>
                                <div class="reaction-btn bg-gray-100 text-gray-800" title="You cannot dislike your own poster">
                                    <i class="fas fa-thumbs-down text-blue-500"></i>
                                    <span class="reaction-count" id="dislike_count_container"><%=DislikesCount%></span>
                                </div>
                                <div class="reaction-btn bg-gray-100 text-gray-800" title="You cannot download your own poster">
                                    <i class="fas fa-download text-green-500"></i>
                                    <span class="reaction-count" id="download_count_container"><%=DownloadsCount%></span>
                                </div>
                            <% } else { %>
                                <button id="LikeButton" class="reaction-btn bg-gray-100 hover:bg-pink-100 text-gray-800">
                                    <i class="fas fa-heart text-gray-400 hover:text-red-500"></i>
                                    <span class="reaction-count" id="like_count_container"><%=likes_count%></span>
                                </button>
                                <button id="DisLikeButton" class="reaction-btn bg-gray-100 hover:bg-blue-100 text-gray-800">
                                    <i class="fas fa-thumbs-down text-gray-400 hover:text-blue-500"></i>
                                    <span class="reaction-count" id="dislike_count_container"><%=DislikesCount%></span>
                                </button>
                                <a id="downloadPoster" href="<%=PosterFile%>" download="<%=PosterTitle%>-<%=Presenter%>-asfischolar.pdf" class="reaction-btn bg-gray-100 hover:bg-green-100 text-gray-800">
                                    <i class="fas fa-download text-gray-400 hover:text-green-500"></i>
                                    <span class="reaction-count" id="download_count_container"><%=DownloadsCount%></span>
                                </a>
                            <% } %>
                        </div>
                    </div>
                    
                    <!-- Rating Section -->
                    <% if(isOwner === true) { %>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-900 mb-2">Poster Ratings</h4>
                            <div class="flex items-center mb-1">
                                <span class="text-2xl font-bold text-primary-600 mr-2" id="average-rating">0</span>
                                <span class="text-gray-500">/ 5</span>
                            </div>
                            <div class="flex mb-2" id="average-star-rating">
                                <% for(let i=1; i<=5; i++) { %>
                                    <span class="star text-gray-300 text-xl">&#9733;</span>
                                <% } %>
                            </div>
                            <p class="text-sm text-gray-600"><span id="total-ratings">0</span> total ratings</p>
                        </div>
                    <% } else { %>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-900 mb-2">Rate this Poster</h4>
                            <p class="text-sm text-gray-600 mb-2">Average: <span id="user-average-rating">0</span>/5</p>
                            <div class="star-rating flex" id="user-star-rating">
                                <% for(let i=1; i<=5; i++) { %>
                                    <span class="star text-gray-300 text-2xl hover:text-yellow-400 mr-1" data-value="<%=i%>">&#9733;</span>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </section>
        
        <!-- Related Posters -->
        <section class="mt-12">
            <h4 class="text-xl font-bold text-gray-900 mb-6 text-center">More Related Posters</h4>
            <div class="bg-white rounded-xl overflow-hidden">
                <iframe src="/posterlist/<%=meeting%>" frameborder="0" id="posterListFrame" class="w-full h-[500px]"></iframe>
            </div>
        </section>
    </div>
</main>
<!-- Main Content END -->

<!-- Chat Box -->
<div class="chatBox fixed bottom-4 right-4 w-80 h-96 bg-white rounded-t-lg shadow-xl hidden" id="chatBox" style="z-index: 998928;">
    <div class="bg-purple-700 text-white p-3 flex justify-between items-center rounded-t-lg">
        <h3 class="font-medium">Chat with Presenter</h3>
        <div class="flex">
            <button id="return" class="text-white hover:text-gray-200 mr-2" onclick="changeSource(`/chat/presenter/<%=PosterId%>`)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button id="closeChat" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <iframe src="/chat/presenter/<%=PosterId%>" frameborder="0" id="chatFrame" class="w-full h-full" style="display: flex; box-sizing: border-box; padding: 0px; margin:0px"></iframe>
</div>


<%- include('./partials/footer.ejs') %>
<!-- Back to top button -->
<div class="fixed bottom-8 right-8 back-top bg-purple-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-purple-700 cursor-pointer">
    <i class="fas fa-arrow-up"></i>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var loaderOverlay = document.getElementById('loader-overlay');
    
    // Hide loader when page is ready
    setTimeout(function() {
        loaderOverlay.style.opacity = 0;
        loaderOverlay.style.visibility = 'hidden';
    }, 500);
    
    // Toggle chat box
    document.getElementById('chatPresenter').addEventListener('click', function() {
        document.getElementById('chatBox').classList.toggle('hidden');
    });
    
    // Close chat box
    document.getElementById('closeChat').addEventListener('click', function() {
        document.getElementById('chatBox').classList.add('hidden');
    });
    
    // Initialize PDF viewer
    initializePDFViewer();
    
    // Initialize reaction buttons
    initializeReactions();
    
    // Initialize star ratings
    initializeRatings();
    
    // Close zoomed view
    document.getElementById('closeZoom').addEventListener('click', function() {
        document.getElementById('pdf-container-1').classList.remove('zoomed');
    });
});

const chatFrame = document.getElementById("chatFrame");
function changeSource(url) {
    chatFrame.src = url;
}

function initializePDFViewer() {
    const pdfContainer = document.getElementById('pdf-container-1');
    const pdfLoading = document.getElementById('pdf-loading');
    const pdfFile = document.getElementById('posterDeckFile').value;
    
    if (pdfFile) {
        // This would be replaced with your actual PDF.js implementation
        // For now we'll simulate loading
        setTimeout(() => {
            pdfLoading.style.display = 'none';
            
            // Create mock pages (replace with actual PDF.js rendering)
            for (let i = 0; i < 3; i++) { // Assuming 3 pages for example
                const page = document.createElement('div');
                page.className = 'pdf-page bg-white p-4';
                page.innerHTML = `
                    <div class="border border-gray-200 p-2">
                        <div class="bg-gray-100 w-full h-96 flex items-center justify-center">
                            <p class="text-gray-500">Page ${i+1} of PDF preview</p>
                        </div>
                    </div>
                `;
                // pdfContainer.appendChild(page);
            }
            
            // Add click-to-zoom functionality
            pdfContainer.addEventListener('click', function() {
                this.classList.toggle('zoomed');
                
                if (this.classList.contains('zoomed')) {
                    // Scroll to top when zoomed
                    this.scrollTo(0, 0);
                    
                    // Disable body scrolling
                    document.body.style.overflow = 'hidden';
                } else {
                    // Enable body scrolling
                    document.body.style.overflow = '';
                }
            });
        }, 1500);
    }
}

function initializeReactions() {
    // Like button functionality
    document.getElementById('LikeButton')?.addEventListener('click', function() {
        const icon = this.querySelector('i');
        const countElement = this.querySelector('.reaction-count');
        
        if (icon.classList.contains('text-red-500')) {
            // Already liked, unlike it
            icon.classList.remove('text-red-500', 'fas');
            icon.classList.add('text-gray-400', 'far');
            countElement.textContent = parseInt(countElement.textContent) - 1;
        } else {
            // Like it
            icon.classList.remove('text-gray-400', 'far');
            icon.classList.add('text-red-500', 'fas');
            countElement.textContent = parseInt(countElement.textContent) + 1;
            
            // Add animation
            this.classList.add('animate-ping');
            setTimeout(() => {
                this.classList.remove('animate-ping');
            }, 500);
        }
    });
    
    // Dislike button functionality
    document.getElementById('DisLikeButton')?.addEventListener('click', function() {
        const icon = this.querySelector('i');
        const countElement = this.querySelector('.reaction-count');
        
        if (icon.classList.contains('text-blue-500')) {
            // Already disliked, undislike it
            icon.classList.remove('text-blue-500', 'fas');
            icon.classList.add('text-gray-400', 'far');
            countElement.textContent = parseInt(countElement.textContent) - 1;
        } else {
            // Dislike it
            icon.classList.remove('text-gray-400', 'far');
            icon.classList.add('text-blue-500', 'fas');
            countElement.textContent = parseInt(countElement.textContent) + 1;
        }
    });
    
    // Download button functionality
    document.getElementById('downloadPoster')?.addEventListener('click', function() {
        const countElement = this.querySelector('.reaction-count');
        countElement.textContent = parseInt(countElement.textContent) + 1;
    });
}

function initializeRatings() {
    const userStarRating = document.getElementById('user-star-rating');
    
    if (userStarRating) {
        const stars = userStarRating.querySelectorAll('.star');
        
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const value = parseInt(this.getAttribute('data-value'));
                
                // Update UI
                stars.forEach((s, i) => {
                    if (i < value) {
                        s.classList.add('text-yellow-400', 'fas');
                        s.classList.remove('text-gray-300', 'far');
                    } else {
                        s.classList.remove('text-yellow-400', 'fas');
                        s.classList.add('text-gray-300', 'far');
                    }
                });
                
                document.getElementById('user-average-rating').textContent = value;
            });
            
            star.addEventListener('mouseover', function() {
                const value = parseInt(this.getAttribute('data-value'));
                stars.forEach((s, i) => {
                    if (i < value) {
                        s.classList.add('text-yellow-400');
                    }
                });
            });
            
            star.addEventListener('mouseout', function() {
                stars.forEach(s => {
                    if (!s.classList.contains('fas')) {
                        s.classList.remove('text-yellow-400');
                    }
                });
            });
        });
    }
    
    // For owners, show the average rating (demo data)
    const averageRating = 4.2;
    document.getElementById('average-rating').textContent = averageRating.toFixed(1);
    document.getElementById('total-ratings').textContent = '15';
    
    const averageStars = document.getElementById('average-star-rating');
    if (averageStars) {
        const stars = averageStars.querySelectorAll('.star');
        const filledStars = Math.floor(averageRating);
        const partialStar = averageRating % 1;
        
        stars.forEach((star, i) => {
            if (i < filledStars) {
                star.classList.add('text-yellow-400', 'fas');
                star.classList.remove('text-gray-300', 'far');
            } else if (i === filledStars && partialStar > 0) {
                star.classList.add('text-yellow-400', 'fas');
                star.classList.remove('text-gray-300', 'far');
                star.style.width = `${partialStar * 100}%`;
                star.style.overflow = 'hidden';
                star.style.display = 'inline-block';
            }
        });
    }
}

</script>

<!-- JavaScript Libraries -->
<script src="/js/jquery-3.4.1.min.js?v=<%= Date.now() %>"></script>
<script src="/js/bootstrap.bundle.min.js?v=<%= Date.now() %>"></script>
<script src="/js/functions.js?v=<%= Date.now() %>"></script>
<script src="/pdfjs/pdf.js?v=<%= Date.now() %>"></script>
<script src="/js/likeDislike.js?v=<%= Date.now() %>"></script>
<script src="/js/pdfjs.js?v=<%= Date.now() %>"></script>
<script src="/js/fetchFiles.js?v=<%= Date.now() %>"></script>
<script src="/js/posterRating.js?v=<%= Date.now() %>" type="module"></script>
</body>
</html>