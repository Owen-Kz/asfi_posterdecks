<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Weperch Technologies Ltd">
    <meta name="description" content="ASFI, African Science Frontiers Initiative, African Scientists, African Scholars, Scholars, Education">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            600: '#7e22ce',
                            700: '#6b21a8',
                        },
                        secondary: {
                            600: '#2563eb',
                        },
                        pink: {
                            500: '#ec4899',
                        },
                        red: {
                            500: '#ef4444',
                        },
                        yellow: {
                            400: '#facc15',
                        }
                    },
                    fontFamily: {
                        inter: [ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"],
                        roboto: [ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"],
                        poppins: [ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"],
                    },
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="/files/images/ASFIScholar_Logo.png" type="image/x-icon">

    <title><%=PosterTitle%> | ASFIScholar</title>
    
    <style>
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s, visibility 0.5s;
        }
        
        .circular-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e5e7eb;
        }
        
        .reaction-btn {
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 20px;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .reaction-btn:hover {
            transform: translateY(-2px);
        }
        
        .reaction-count {
            margin-left: 6px;
            font-weight: 500;
        }
        
        .star-rating .star {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .star-rating .star:hover {
            transform: scale(1.2);
        }
        
        .chatBox {
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .back-top {
            transition: all 0.3s ease;
        }
        
        .back-top:hover {
            transform: translateY(-3px);
        }
        
        #pdf-container-1 {
            width: 100%;
            height: 100%;
            min-height: 500px;
            overflow: auto;
            cursor: zoom-in;
            transition: all 0.3s ease;
        }
        
        #pdf-container-1.zoomed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9998;
            cursor: zoom-out;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #pdf-container-1.zoomed .pdf-page {
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .pdf-page {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        #pdf-container-1:not(.zoomed) .pdf-page:hover {
            transform: scale(1.02);
        }
        
        .pdf-page:last-child {
            margin-bottom: 0;
        }
        
        #pdf-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .close-zoom {
            /* position: absolute; */
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 9999;
            display: none;
        }
        
        #pdf-container-1.zoomed ~ .close-zoom {
            display: block;
        }
    </style>
</head>

<body class="font-poppins bg-gray-50">

<div class="loader-overlay" id="loader-overlay">
    <div class="flex flex-col items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"></div>
        <span class="text-primary-600">Loading</span>
    </div>
</div>

<input type="hidden" id="posterID" value="<%=PosterId%>" readonly>

<!-- Header START -->
<%- include('./partials/header.ejs')%>
<!-- Header END -->

<!-- Main Content START -->
<main class="py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">
        <!-- Poster Preview Section -->
        <section class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="md:flex">
                <!-- PDF Preview -->
    
<!-- PDF Preview Section -->
<div class="md:w-2/3 p-6 relative" style="min-height: 80vh;">
    <input type="hidden" id="posterDeckFile" value="<%=PosterFile%>">
    <input type="hidden" id="isLink" value="<%= is_link || 0 %>">
    <input type="hidden" id="presenterImageFile" value="<%=PresenterImage%>">
    
    <!-- PDF Viewer Container -->
    <div id="pdf-viewer-container" class="w-full h-full border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 flex items-center justify-center">
        <div id="pdf-loading" class="text-center p-8">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">Loading PDF viewer...</p>
        </div>
        
        <!-- Cloudinary PDF Viewer (hidden by default) -->
        <div id="cloudinary-viewer" class="hidden w-full h-full relative">
            <iframe id="cloudinary-iframe" src="" class="w-full h-full rounded-lg shadow-lg" frameborder="0"></iframe>
            <div class="absolute top-4 right-4 flex gap-2">
                <button id="cloudinary-zoom" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-md flex items-center">
                    <i class="fas fa-expand mr-2"></i> Zoom
                </button>
                <a id="cloudinary-download" href="" target="_blank" 
                   class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-md flex items-center">
                    <i class="fas fa-download mr-2"></i> Download
                </a>
                <a id="cloudinary-open" href="" target="_blank"
                   class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-md flex items-center">
                    <i class="fas fa-external-link-alt mr-2"></i> Open
                </a>
            </div>
        </div>
        
        <!-- Local PDF Viewer (hidden by default) -->
   <!-- Local PDF Viewer (hidden by default) -->
<div id="local-pdf-viewer" class="hidden w-full h-full relative">
    <div id="pdf-container" class="w-full h-full overflow-y-auto bg-white rounded-lg shadow-lg p-0"></div>
    <div class="absolute top-4 right-4 flex gap-2">
        <button id="local-zoom" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-md flex items-center">
            <i class="fas fa-expand mr-2"></i> Zoom
        </button>
        <!-- Add these missing buttons -->
        <button id="zoom-in" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
            <i class="fas fa-search-plus"></i>
        </button>
        <button id="zoom-out" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
            <i class="fas fa-search-minus"></i>
        </button>
        <a id="local-download" href="" download
           class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center">
            <i class="fas fa-download mr-2"></i> Download
        </a>
    </div>
</div>
        
        <!-- Error State -->
        <div id="pdf-error" class="hidden text-center p-8">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Failed to Load PDF</h3>
            <p class="text-gray-600 mb-4" id="error-message"></p>
            <button id="retry-load" class="bg-primary-500 hover:bg-primary-600 text-white px-6 py-2 rounded-md font-medium transition-colors">
                Try Again
            </button>
        </div>
    </div>
</div>

<!-- Zoom Modal -->
<div id="zoom-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden transition-opacity duration-300">
    <div class="absolute top-4 right-4 flex gap-2 z-60">
        <button id="modal-zoom-in" class="bg-white hover:bg-gray-100 text-gray-800 px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-lg flex items-center">
            <i class="fas fa-search-plus mr-2"></i> Zoom In
        </button>
        <button id="modal-zoom-out" class="bg-white hover:bg-gray-100 text-gray-800 px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-lg flex items-center">
            <i class="fas fa-search-minus mr-2"></i> Zoom Out
        </button>
        <button id="modal-close" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-lg flex items-center">
            <i class="fas fa-times mr-2"></i> Close
        </button>
    </div>
    
    <div class="absolute top-4 left-4 text-white z-60">
        <span id="page-info" class="bg-black bg-opacity-50 px-3 py-2 rounded-md text-sm"></span>
    </div>
    
    <div class="w-full h-full flex items-center justify-center p-8">
        <div id="modal-pdf-container" class="max-w-full max-h-full overflow-auto bg-white rounded-lg shadow-2xl">
            <!-- PDF pages will be rendered here -->
        </div>
    </div>
    
    <!-- Navigation Arrows -->
    <button id="prev-page" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white hover:bg-gray-100 text-gray-800 w-12 h-12 rounded-full shadow-lg flex items-center justify-center z-60 transition-all duration-200 opacity-80 hover:opacity-100">
        <i class="fas fa-chevron-left text-xl"></i>
    </button>
    <button id="next-page" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white hover:bg-gray-100 text-gray-800 w-12 h-12 rounded-full shadow-lg flex items-center justify-center z-60 transition-all duration-200 opacity-80 hover:opacity-100">
        <i class="fas fa-chevron-right text-xl"></i>
    </button>
</div>
                <!-- Poster Info -->
                <div class="md:w-1/3 p-6 border-l border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-regular text-gray-900"><%=PosterTitle%></h2>
                        <span class="flex items-center text-gray-500">
                            <i class="fas fa-eye mr-1"></i>
                            <span id="view_count_container"><%=ViewsCount%></span>
                        </span>
                    </div>
                    
                    <!-- Presenter Info -->
                    <div class="mb-6">
                        <h5 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Presented By</h5>
                        <div class="flex items-center">
                            <img alt="Presenter" class="circular-image" id="presenterImage" src="<%= PresenterImage %>">
                            <div class="ml-4">
                                <p class="font-medium text-gray-900"><%=Presenter%></p>
                                <p class="text-sm text-gray-500"><%= affiliation %> <%= country %></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mb-6">
                        <% if(isOwner === true) { %>
                            <button id="chatPresenter" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md transition-all">
                                <i class="fas fa-comments mr-2"></i> See Messages
                            </button>
                        <% } else { %>
                            <button id="chatPresenter" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md transition-all">
                                <i class="fas fa-comments mr-2"></i> Chat With Presenter
                            </button>
                        <% } %>
                    </div>
                    
                    <!-- Reactions -->
                    <div class="mb-6">
                        <div class="flex flex-wrap mb-4">
                            <% if(isOwner === true) { %>
                                <div class="reaction-btn bg-gray-100 text-gray-800" title="You cannot like your own poster">
                                    <i class="fas fa-heart text-red-500"></i>
                                    <span class="reaction-count" id="like_count_container"><%=likes_count%></span>
                                </div>
                                <div class="reaction-btn bg-gray-100 text-gray-800" title="You cannot dislike your own poster">
                                    <i class="fas fa-thumbs-down text-blue-500"></i>
                                    <span class="reaction-count" id="dislike_count_container"><%=DislikesCount%></span>
                                </div>
                                 <div class="reaction-btn bg-gray-100 text-gray-800" title="You cannot download your own poster">
        <i class="fas fa-download text-green-500"></i>
        <span class="reaction-count" id="download_count_container"><%=DownloadsCount%></span>
    </div>
                            <% } else { %>
                                <button id="LikeButton" class="reaction-btn bg-gray-100 hover:bg-pink-100 text-gray-800">
                                    <i class="fas fa-heart text-gray-400 hover:text-red-500"></i>
                                    <span class="reaction-count" id="like_count_container"><%=likes_count%></span>
                                </button>
                                <button id="DisLikeButton" class="reaction-btn bg-gray-100 hover:bg-blue-100 text-gray-800">
                                    <i class="fas fa-thumbs-down text-gray-400 hover:text-blue-500"></i>
                                    <span class="reaction-count" id="dislike_count_container"><%=DislikesCount%></span>
                                </button>
                               <a id="downloadPoster" 
       href="<%= is_link ? PosterFile : '/files/uploaded/posterpdf/' + PosterFile %>" 
       download="<%=PosterTitle%>-<%=Presenter%>-asfischolar.pdf" 
       class="reaction-btn bg-gray-100 hover:bg-green-100 text-gray-800">
        <i class="fas fa-download text-gray-400 hover:text-green-500"></i>
        <span class="reaction-count" id="download_count_container"><%=DownloadsCount%></span>
    </a>
                            <% } %>
                        </div>
                    </div>
                    
                    <!-- Rating Section -->
                    <% if(isOwner === true) { %>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-900 mb-2">Poster Ratings</h4>
                            <div class="flex items-center mb-1">
                                <span class="text-2xl font-bold text-primary-600 mr-2" id="average-rating">0</span>
                                <span class="text-gray-500">/ 5</span>
                            </div>
                            <div class="flex mb-2" id="average-star-rating">
                                <% for(let i=1; i<=5; i++) { %>
                                    <span class="star text-gray-300 text-xl">&#9733;</span>
                                <% } %>
                            </div>
                            <p class="text-sm text-gray-600"><span id="total-ratings">0</span> total ratings</p>
                        </div>
                    <% } else { %>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-900 mb-2">Rate this Poster</h4>
                            <p class="text-sm text-gray-600 mb-2">Average: <span id="user-average-rating">0</span>/5</p>
                            <div class="star-rating flex" id="user-star-rating">
                                <% for(let i=1; i<=5; i++) { %>
                                    <span class="star text-gray-300 text-2xl hover:text-yellow-400 mr-1" data-value="<%=i%>">&#9733;</span>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </section>
        
        <!-- Related Posters -->
        <section class="mt-12">
            <h4 class="text-xl font-bold text-gray-900 mb-6 text-center">More Related Posters</h4>
            <div class="bg-white rounded-xl overflow-hidden">
                <iframe src="/posterlist/<%=meeting%>" frameborder="0" id="posterListFrame" class="w-full h-[500px]"></iframe>
            </div>
        </section>
    </div>
</main>
<!-- Main Content END -->

<!-- Chat Box -->
<div class="chatBox fixed bottom-4 right-4 w-80 h-96 bg-white rounded-t-lg shadow-xl hidden" id="chatBox" style="z-index: 998928;">
    <div class="bg-purple-700 text-white p-3 flex justify-between items-center rounded-t-lg">
        <h3 class="font-medium">Chat with Presenter</h3>
        <div class="flex">
            <button id="return" class="text-white hover:text-gray-200 mr-2" onclick="changeSource(`/chat/presenter/<%=PosterId%>`)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button id="closeChat" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <iframe src="/chat/presenter/<%=PosterId%>" frameborder="0" id="chatFrame" class="w-full h-full" style="display: flex; box-sizing: border-box; padding: 0px; margin:0px"></iframe>
</div>


<%- include('./partials/footer.ejs') %>
<!-- Back to top button -->
<div class="fixed bottom-8 right-8 back-top bg-purple-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-purple-700 cursor-pointer">
    <i class="fas fa-arrow-up"></i>
</div>
<Script>
    document.addEventListener('DOMContentLoaded', function () {
    var loaderOverlay = document.getElementById('loader-overlay');
    
    // Hide loader when page is ready
    setTimeout(function() {
        loaderOverlay.style.opacity = 0;
        loaderOverlay.style.visibility = 'hidden';
    }, 500);
    
    // Toggle chat box
    document.getElementById('chatPresenter').addEventListener('click', function() {
        document.getElementById('chatBox').classList.toggle('hidden');
    });
    
    // Close chat box
    document.getElementById('closeChat').addEventListener('click', function() {
        document.getElementById('chatBox').classList.add('hidden');
    });
    
    // Initialize PDF viewer
    initializePDFViewer();
    
    // Initialize reaction buttons
    initializeReactions();
    
    // Initialize star ratings
    initializeRatings();
});

const chatFrame = document.getElementById("chatFrame");
function changeSource(url) {
    chatFrame.src = url;
}

let currentPDF = null;
let currentPage = 1;
let totalPages = 1;
let modalScale = 1.0;

function initializePDFViewer() {
    const pdfFile = document.getElementById('posterDeckFile').value;
    const isLink = document.getElementById('isLink').value === '1' || document.getElementById('isLink').value === 'true';
    const loadingElement = document.getElementById('pdf-loading');
    const cloudinaryViewer = document.getElementById('cloudinary-viewer');
    const localViewer = document.getElementById('local-pdf-viewer');
    const errorElement = document.getElementById('pdf-error');
    
    console.log('Initializing PDF viewer:', { pdfFile, isLink });

    // Hide loading after a brief moment
    setTimeout(() => {
        loadingElement.classList.add('hidden');
        
        if (isLink) {
            // Handle Cloudinary PDF
            initializeCloudinaryViewer(pdfFile, cloudinaryViewer);
        } else {
            // Handle Local PDF
            initializeLocalPDFViewer(pdfFile, localViewer);
        }
    }, 1000);
}

function initializeCloudinaryViewer(pdfUrl, container) {
    console.log('Initializing Cloudinary viewer:', pdfUrl);
    
    const iframe = document.getElementById('cloudinary-iframe');
    const downloadBtn = document.getElementById('cloudinary-download');
    const openBtn = document.getElementById('cloudinary-open');
    const zoomBtn = document.getElementById('cloudinary-zoom');
    
    // Set URLs
    iframe.src = pdfUrl;
    downloadBtn.href = pdfUrl;
    openBtn.href = pdfUrl;
    
    // Show the container
    container.classList.remove('hidden');
    
    // Zoom functionality for Cloudinary
    if (zoomBtn) {
        zoomBtn.addEventListener('click', () => {
            openCloudinaryZoomModal(pdfUrl);
        });
    }
    
    // Handle iframe load events
    iframe.onload = function() {
        console.log('Cloudinary PDF loaded successfully');
    };
    
    iframe.onerror = function() {
        showError('Failed to load Cloudinary PDF. The file may be unavailable.');
    };
}

function initializeLocalPDFViewer(pdfUrl, container) {
    console.log('Initializing local PDF viewer:', pdfUrl);
    
    const pdfContainer = document.getElementById('pdf-container');
    const downloadBtn = document.getElementById('local-download');
    const zoomBtn = document.getElementById('local-zoom');
    
    // Set download URL
    downloadBtn.href = pdfUrl;
    downloadBtn.target = '_blank';
    
    // Load PDF using PDF.js
    fetch(pdfUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.blob();
        })
        .then(blob => {
            if (blob.size === 0) {
                throw new Error('PDF file is empty');
            }
            
            const fileURL = URL.createObjectURL(blob);
            return pdfjsLib.getDocument(fileURL).promise;
        })
        .then(pdf => {
            currentPDF = pdf;
            totalPages = pdf.numPages;
            console.log('PDF loaded successfully. Pages:', totalPages);
            
            // Clear container
            pdfContainer.innerHTML = '';
            
            // Render first page only in container view
            return renderPageForContainer(pdf, 1, pdfContainer);
        })
        .then(() => {
            // Show the container
            container.classList.remove('hidden');
            console.log('PDF page rendered successfully in container');
            
            // Setup zoom functionality - ONLY attach the click event to open modal
            if (zoomBtn) {
                zoomBtn.addEventListener('click', () => {
                    openLocalZoomModal();
                });
            }
        })
        .catch(error => {
            console.error('Error loading local PDF:', error);
            showError(`Failed to load PDF: ${error.message}`);
        });
}

function renderPageForContainer(pdf, pageNumber, container) {
    return pdf.getPage(pageNumber).then(page => {
        // Calculate scale to fit container width (max 800px wide)
        const containerWidth = 800; // Max width for container view
        const viewport = page.getViewport({ scale: 1.0 });
        const scale = Math.min(containerWidth / viewport.width, 1.0);
        const scaledViewport = page.getViewport({ scale: scale });
        
        const pageDiv = document.createElement('div');
        pageDiv.className = 'pdf-page mb-4 bg-white rounded-lg shadow-sm overflow-hidden';
        pageDiv.style.maxWidth = '100%';
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        canvas.width = scaledViewport.width;
        canvas.height = scaledViewport.height;
        canvas.className = 'mx-auto';
        canvas.style.maxWidth = '100%';
        canvas.style.height = 'auto';
        
        pageDiv.appendChild(canvas);
        container.appendChild(pageDiv);
        
        const renderContext = {
            canvasContext: context,
            viewport: scaledViewport
        };
        
        return page.render(renderContext).promise;
    });
}

function openCloudinaryZoomModal(pdfUrl) {
    const modal = document.getElementById('zoom-modal');
    const iframe = document.createElement('iframe');
    
    // Clear modal container
    const modalContainer = document.getElementById('modal-pdf-container');
    modalContainer.innerHTML = '';
    
    // Create full-size iframe for Cloudinary
    iframe.src = pdfUrl;
    iframe.className = 'w-full h-full min-h-[80vh]';
    iframe.style.border = 'none';
    
    modalContainer.appendChild(iframe);
    
    // Hide navigation for Cloudinary (since it's one embedded PDF)
    document.getElementById('prev-page').classList.add('hidden');
    document.getElementById('next-page').classList.add('hidden');
    document.getElementById('page-info').classList.add('hidden');
    document.getElementById('modal-zoom-in').classList.add('hidden');
    document.getElementById('modal-zoom-out').classList.add('hidden');
    
    // Setup modal close event
    setupModalCloseEvents();
    
    // Show modal
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function openLocalZoomModal() {
    const modal = document.getElementById('zoom-modal');
    const modalContainer = document.getElementById('modal-pdf-container');
    
    // Clear modal container
    modalContainer.innerHTML = '';
    
    // Show navigation for local PDF
    document.getElementById('prev-page').classList.remove('hidden');
    document.getElementById('next-page').classList.remove('hidden');
    document.getElementById('page-info').classList.remove('hidden');
    document.getElementById('modal-zoom-in').classList.remove('hidden');
    document.getElementById('modal-zoom-out').classList.remove('hidden');
    
    // Reset modal state
    currentPage = 1;
    modalScale = 1.0;
    
    // Render first page in modal
    renderPageForModal(currentPage).then(() => {
        updatePageInfo();
    });
    
    // Setup modal event listeners
    setupModalEvents();
    
    // Show modal
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function renderPageForModal(pageNumber) {
    return currentPDF.getPage(pageNumber).then(page => {
        const modalContainer = document.getElementById('modal-pdf-container');
        
        // Clear previous content
        modalContainer.innerHTML = '';
        
        const viewport = page.getViewport({ scale: modalScale });
        
        const pageDiv = document.createElement('div');
        pageDiv.className = 'pdf-page bg-white p-0';
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        canvas.className = 'mx-auto shadow-lg';
        
        pageDiv.appendChild(canvas);
        modalContainer.appendChild(pageDiv);
        
        const renderContext = {
            canvasContext: context,
            viewport: viewport
        };
        
        return page.render(renderContext).promise;
    });
}

function setupModalEvents() {
    const closeBtn = document.getElementById('modal-close');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const zoomInBtn = document.getElementById('modal-zoom-in');
    const zoomOutBtn = document.getElementById('modal-zoom-out');
    
    // Close modal
    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }
    
    // Page navigation
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPageForModal(currentPage).then(updatePageInfo);
            }
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderPageForModal(currentPage).then(updatePageInfo);
            }
        });
    }
    
    // Zoom controls
    if (zoomInBtn) {
        zoomInBtn.addEventListener('click', () => {
            modalScale = Math.min(modalScale + 0.25, 3.0);
            renderPageForModal(currentPage).then(updatePageInfo);
        });
    }
    
    if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', () => {
            modalScale = Math.max(modalScale - 0.25, 0.5);
            renderPageForModal(currentPage).then(updatePageInfo);
        });
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', handleKeyboardNavigation);
}

function setupModalCloseEvents() {
    const modal = document.getElementById('zoom-modal');
    const closeBtn = document.getElementById('modal-close');
    
    // Close modal
    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }
    
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
    }
    
    // Keyboard close
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
}

function handleKeyboardNavigation(e) {
    const modal = document.getElementById('zoom-modal');
    if (modal && modal.classList.contains('hidden')) return;
    
    switch(e.key) {
        case 'Escape':
            closeModal();
            break;
        case 'ArrowLeft':
            if (currentPage > 1) {
                currentPage--;
                renderPageForModal(currentPage).then(updatePageInfo);
            }
            break;
        case 'ArrowRight':
            if (currentPage < totalPages) {
                currentPage++;
                renderPageForModal(currentPage).then(updatePageInfo);
            }
            break;
        case '+':
        case '=':
            modalScale = Math.min(modalScale + 0.25, 3.0);
            renderPageForModal(currentPage).then(updatePageInfo);
            break;
        case '-':
            modalScale = Math.max(modalScale - 0.25, 0.5);
            renderPageForModal(currentPage).then(updatePageInfo);
            break;
    }
}

function updatePageInfo() {
    const pageInfo = document.getElementById('page-info');
    if (pageInfo) {
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    }
}

function closeModal() {
    const modal = document.getElementById('zoom-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
    document.body.style.overflow = '';
    
    // Clean up event listeners
    document.removeEventListener('keydown', handleKeyboardNavigation);
}

function showError(message) {
    const loadingElement = document.getElementById('pdf-loading');
    const errorElement = document.getElementById('pdf-error');
    const errorMessage = document.getElementById('error-message');
    const retryBtn = document.getElementById('retry-load');
    
    loadingElement.classList.add('hidden');
    if (errorMessage) {
        errorMessage.textContent = message;
    }
    errorElement.classList.remove('hidden');
    
    if (retryBtn) {
        retryBtn.addEventListener('click', function() {
            errorElement.classList.add('hidden');
            loadingElement.classList.remove('hidden');
            initializePDFViewer();
        });
    }
}

// Remove all duplicate function definitions below this point
// Keep only the initializeReactions and initializeRatings functions that follow

function initializeReactions() {
    // Like button functionality
    document.getElementById('LikeButton')?.addEventListener('click', function() {
        const icon = this.querySelector('i');
        const countElement = this.querySelector('.reaction-count');
        
        if (icon.classList.contains('text-red-500')) {
            // Already liked, unlike it
            icon.classList.remove('text-red-500', 'fas');
            icon.classList.add('text-gray-400', 'far');
            countElement.textContent = parseInt(countElement.textContent) - 1;
        } else {
            // Like it
            icon.classList.remove('text-gray-400', 'far');
            icon.classList.add('text-red-500', 'fas');
            countElement.textContent = parseInt(countElement.textContent) + 1;
            
            // Add animation
            this.classList.add('animate-ping');
            setTimeout(() => {
                this.classList.remove('animate-ping');
            }, 500);
        }
    });
    
    // Dislike button functionality
    document.getElementById('DisLikeButton')?.addEventListener('click', function() {
        const icon = this.querySelector('i');
        const countElement = this.querySelector('.reaction-count');
        
        if (icon.classList.contains('text-blue-500')) {
            // Already disliked, undislike it
            icon.classList.remove('text-blue-500', 'fas');
            icon.classList.add('text-gray-400', 'far');
            countElement.textContent = parseInt(countElement.textContent) - 1;
        } else {
            // Dislike it
            icon.classList.remove('text-gray-400', 'far');
            icon.classList.add('text-blue-500', 'fas');
            countElement.textContent = parseInt(countElement.textContent) + 1;
        }
    });
    
    // Download button functionality
    document.getElementById('downloadPoster')?.addEventListener('click', function() {
        const countElement = this.querySelector('.reaction-count');
        countElement.textContent = parseInt(countElement.textContent) + 1;
    });
}

function initializeRatings() {
    const userStarRating = document.getElementById('user-star-rating');
    
    if (userStarRating) {
        const stars = userStarRating.querySelectorAll('.star');
        
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const value = parseInt(this.getAttribute('data-value'));
                
                // Update UI
                stars.forEach((s, i) => {
                    if (i < value) {
                        s.classList.add('text-yellow-400', 'fas');
                        s.classList.remove('text-gray-300', 'far');
                    } else {
                        s.classList.remove('text-yellow-400', 'fas');
                        s.classList.add('text-gray-300', 'far');
                    }
                });
                
                document.getElementById('user-average-rating').textContent = value;
            });
            
            star.addEventListener('mouseover', function() {
                const value = parseInt(this.getAttribute('data-value'));
                stars.forEach((s, i) => {
                    if (i < value) {
                        s.classList.add('text-yellow-400');
                    }
                });
            });
            
            star.addEventListener('mouseout', function() {
                stars.forEach(s => {
                    if (!s.classList.contains('fas')) {
                        s.classList.remove('text-yellow-400');
                    }
                });
            });
        });
    }
    
    // For owners, show the average rating (demo data)
    const averageRating = 4.2;
    document.getElementById('average-rating').textContent = averageRating.toFixed(1);
    document.getElementById('total-ratings').textContent = '15';
    
    const averageStars = document.getElementById('average-star-rating');
    if (averageStars) {
        const stars = averageStars.querySelectorAll('.star');
        const filledStars = Math.floor(averageRating);
        const partialStar = averageRating % 1;
        
        stars.forEach((star, i) => {
            if (i < filledStars) {
                star.classList.add('text-yellow-400', 'fas');
                star.classList.remove('text-gray-300', 'far');
            } else if (i === filledStars && partialStar > 0) {
                star.classList.add('text-yellow-400', 'fas');
                star.classList.remove('text-gray-300', 'far');
                star.style.width = `${partialStar * 100}%`;
                star.style.overflow = 'hidden';
                star.style.display = 'inline-block';
            }
        });
    }
}
</Script>

<!-- JavaScript Libraries -->
<script src="/js/jquery-3.4.1.min.js?v=<%= Date.now() %>"></script>
<script src="/js/bootstrap.bundle.min.js?v=<%= Date.now() %>"></script>
<script src="/js/functions.js?v=<%= Date.now() %>"></script>
<script src="/pdfjs/pdf.js?v=<%= Date.now() %>"></script>
<script src="/js/likeDislike.js?v=<%= Date.now() %>"></script>
<script src="/js/pdfjs.js?v=<%= Date.now() %>"></script>
<script src="/js/fetchFiles.js?v=<%= Date.now() %>"></script>
<script src="/js/posterRating.js?v=<%= Date.now() %>" type="module"></script>
</body>
</html>